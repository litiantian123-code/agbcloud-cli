name: Push to Homebrew Tap

# æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼Œå¸¦æœ‰å‚æ•°æ§åˆ¶æ˜¯å¦æ‰§è¡Œæ¨é€
on:
  workflow_dispatch:
    inputs:
      push_to_tap:
        description: 'Push rb file to homebrew-agb repository (true/false)'
        required: true
        type: boolean
        default: false
      version:
        description: 'Version for the Formula (optional, will use latest tag if not provided)'
        required: false
        type: string
        default: ''

# æƒé™è®¾ç½®
permissions:
  contents: read
  actions: read

# ç¯å¢ƒå˜é‡
env:
  HOMEBREW_TAP_REPO: 'homebrew-agb'  # ç›®æ ‡ä»“åº“åç§°
  SOURCE_RB_PATH: 'homebrew/agb.rb'  # æºrbæ–‡ä»¶è·¯å¾„
  TARGET_RB_PATH: 'Formula/agb.rb'   # ç›®æ ‡rbæ–‡ä»¶è·¯å¾„

jobs:
  push-to-homebrew-tap:
    name: Push Formula to Homebrew Tap
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    # åªæœ‰å½“å‚æ•°ä¸ºtrueæ—¶æ‰æ‰§è¡Œ
    if: ${{ github.event.inputs.push_to_tap == 'true' }}
    
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git configuration
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Validate source rb file
        run: |
          echo "Checking source rb file..."
          if [[ ! -f "${{ env.SOURCE_RB_PATH }}" ]]; then
            echo "âŒ Source rb file not found: ${{ env.SOURCE_RB_PATH }}"
            exit 1
          fi
          
          echo "âœ… Source rb file found: ${{ env.SOURCE_RB_PATH }}"
          echo "File content preview:"
          head -10 "${{ env.SOURCE_RB_PATH }}"

      - name: Determine version
        id: version
        env:
          GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            INPUT_VERSION="${{ github.event.inputs.version }}"
            echo "Validating input version: $INPUT_VERSION"
            
            # éªŒè¯ç‰ˆæœ¬æ˜¯å¦åœ¨GitHub releasesä¸­å­˜åœ¨
            RELEASE_EXISTS=$(gh api repos/${{ github.repository }}/releases/tags/v$INPUT_VERSION --silent 2>/dev/null && echo "true" || echo "false")
            
            if [[ "$RELEASE_EXISTS" == "true" ]]; then
              VERSION="$INPUT_VERSION"
              echo "âœ… Version v$VERSION found in releases"
            else
              echo "âŒ Version v$INPUT_VERSION not found in GitHub releases"
              echo "Available releases:"
              gh api repos/${{ github.repository }}/releases --jq '.[].tag_name' | head -10
              exit 1
            fi
          else
            # ä»rbæ–‡ä»¶ä¸­è¯»å–å½“å‰ç‰ˆæœ¬å·
            echo "Reading version from rb file: ${{ env.SOURCE_RB_PATH }}"
            
            if [[ ! -f "${{ env.SOURCE_RB_PATH }}" ]]; then
              echo "âŒ Source rb file not found: ${{ env.SOURCE_RB_PATH }}"
              exit 1
            fi
            
            # ä»rbæ–‡ä»¶ä¸­æå–ç‰ˆæœ¬å· (å¯»æ‰¾ url "...v1.2.3.tar.gz" æ ¼å¼)
            VERSION=$(grep -o 'tags/v[0-9]\+\.[0-9]\+\.[0-9]\+' "${{ env.SOURCE_RB_PATH }}" | head -1 | sed 's/tags\/v//')
            
            if [[ -z "$VERSION" ]]; then
              echo "âŒ Could not extract version from rb file"
              echo "Rb file content:"
              cat "${{ env.SOURCE_RB_PATH }}"
              exit 1
            fi
            
            echo "âœ… Using version from rb file: $VERSION"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Final version: $VERSION"

      - name: Update rb file with current version
        # åªæœ‰å½“ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥äº†ç‰ˆæœ¬å·æ—¶æ‰æ‰§è¡Œæ›´æ–°æ“ä½œ
        if: ${{ github.event.inputs.version != '' }}
        run: |
          echo "Updating rb file with version $VERSION..."
          
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶æ¥æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯
          cp "${{ env.SOURCE_RB_PATH }}" /tmp/agb.rb.tmp
          
          # æ›´æ–°ç‰ˆæœ¬å·ï¼ˆå¦‚æœrbæ–‡ä»¶ä¸­æœ‰ç‰ˆæœ¬ä¿¡æ¯ï¼‰
          sed -i "s/version \"[^\"]*\"/version \"$VERSION\"/g" /tmp/agb.rb.tmp
          
          # æ›´æ–°URLä¸­çš„ç‰ˆæœ¬æ ‡ç­¾
          sed -i "s|/tags/v[^/]*/|/tags/v$VERSION/|g" /tmp/agb.rb.tmp
          
          echo "Updated rb file content:"
          echo "========================"
          cat /tmp/agb.rb.tmp
          echo "========================"

      - name: Use existing rb file (no version update)
        # å½“ç”¨æˆ·æ²¡æœ‰è¾“å…¥ç‰ˆæœ¬å·æ—¶ï¼Œç›´æ¥ä½¿ç”¨ç°æœ‰çš„rbæ–‡ä»¶
        if: ${{ github.event.inputs.version == '' }}
        run: |
          echo "Using existing rb file without version update..."
          echo "Version will be read from existing rb file: $VERSION"
          
          # ç›´æ¥å¤åˆ¶ç°æœ‰çš„rbæ–‡ä»¶
          cp "${{ env.SOURCE_RB_PATH }}" /tmp/agb.rb.tmp
          
          echo "Existing rb file content:"
          echo "========================"
          cat /tmp/agb.rb.tmp
          echo "========================"

      - name: Clone or create homebrew-agb repository
        env:
          GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          echo "Cloning homebrew-agb repository..."
          echo "Repository URL: https://github.com/agbcloud/${{ env.HOMEBREW_TAP_REPO }}.git"
          
          # å…‹éš†ç›®æ ‡ä»“åº“
          git clone "https://x-access-token:${{ secrets.HOMEBREW_TAP_TOKEN }}@github.com/agbcloud/${{ env.HOMEBREW_TAP_REPO }}.git" homebrew-tap
          
          echo "âœ… Successfully cloned homebrew-agb repository"
          
          # æ˜¾ç¤ºä»“åº“ä¿¡æ¯
          cd homebrew-tap
          echo "Current branch: $(git branch --show-current)"
          echo "Repository structure:"
          ls -la
          cd ..

      - name: Update Formula in homebrew-agb repository
        run: |
          echo "Updating Formula in homebrew-agb repository..."
          
          cd homebrew-tap
          
          # æ£€æŸ¥Formulaç›®å½•æ˜¯å¦å­˜åœ¨
          if [[ -d "Formula" ]]; then
            echo "âœ… Formula directory already exists"
          else
            echo "ğŸ“ Formula directory not found, creating it..."
            mkdir -p Formula
            echo "âœ… Formula directory created successfully"
          fi
          
          # éªŒè¯Formulaç›®å½•ç¡®å®å­˜åœ¨
          if [[ ! -d "Formula" ]]; then
            echo "âŒ Failed to create Formula directory"
            exit 1
          fi
          
          # å¤åˆ¶æ›´æ–°åçš„rbæ–‡ä»¶åˆ°ç›®æ ‡ä½ç½®
          cp /tmp/agb.rb.tmp "${{ env.TARGET_RB_PATH }}"
          
          echo "âœ… Formula file updated at ${{ env.TARGET_RB_PATH }}"
          
          # æ˜¾ç¤ºæ–‡ä»¶å†…å®¹ç¡®è®¤
          echo "Updated Formula content:"
          echo "========================"
          cat "${{ env.TARGET_RB_PATH }}"
          echo "========================"

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          cd homebrew-tap
          
          echo "ğŸ“ Preparing to commit and push Formula file..."
          
          # æ·»åŠ å˜æ›´ï¼ˆæ— è®ºæ˜¯å¦æœ‰å®é™…å˜æ›´ï¼‰
          git add "${{ env.TARGET_RB_PATH }}"
          
          # åˆ›å»ºæäº¤ä¿¡æ¯
          COMMIT_MSG="Update agb formula to version $VERSION
          
          - Updated from source repository: ${{ github.repository }}
          - Source file: ${{ env.SOURCE_RB_PATH }}
          - Target file: ${{ env.TARGET_RB_PATH }}
          - Triggered by: ${{ github.actor }}
          - Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          - Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          # æäº¤å˜æ›´ï¼ˆå…è®¸ç©ºæäº¤ï¼‰
          git commit -m "$COMMIT_MSG" --allow-empty
          echo "âœ… Formula committed successfully"
          
          # æ¨é€åˆ°è¿œç¨‹ä»“åº“
          echo "Pushing changes to homebrew-agb repository..."
          if git push origin main 2>/dev/null || git push origin master 2>/dev/null; then
            echo "âœ… Successfully pushed Formula to homebrew-agb repository"
          else
            echo "âš ï¸ Failed to push to existing branch, trying to create new branch..."
            git push -u origin HEAD:main
            echo "âœ… Successfully created and pushed to main branch"
          fi

      - name: Summary
        run: |
          echo ""
          echo "ğŸ‰ Formula push completed successfully!"
          echo ""
          echo "ğŸ“‹ Summary:"
          echo "  - Source repository: ${{ github.repository }}"
          echo "  - Target repository: agbcloud/${{ env.HOMEBREW_TAP_REPO }}"
          echo "  - Formula version: $VERSION"
          echo "  - Source file: ${{ env.SOURCE_RB_PATH }}"
          echo "  - Target file: ${{ env.TARGET_RB_PATH }}"
          echo ""
          echo "ğŸº Users can now install with:"
          echo "  brew tap agbcloud/${{ env.HOMEBREW_TAP_REPO }}"
          echo "  brew install agb"
          echo ""
          echo "ğŸ”— Repository URL:"
          echo "  https://github.com/agbcloud/${{ env.HOMEBREW_TAP_REPO }}"

  # å½“å‚æ•°ä¸ºfalseæ—¶æ˜¾ç¤ºè·³è¿‡ä¿¡æ¯
  skip-push:
    name: Skip Push (Parameter is false)
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.push_to_tap != 'true' }}
    
    steps:
      - name: Skip message
        run: |
          echo "â­ï¸ Skipping push to agbcloud-homebrew repository"
          echo "   Reason: push_to_tap parameter is set to '${{ github.event.inputs.push_to_tap }}'"
          echo "   To enable push, set the parameter to 'true' when running this workflow manually"