# AgbCloud CLI Homebrew Tap æµ‹è¯•åŒ…åˆ†å‘æµæ°´çº¿
name: AgbCloud CLI Test Package Distribution

# è‡ªåŠ¨è§¦å‘æ¡ä»¶
triggers:
  push:
    branches:
      - master
      - main

# å…¨å±€å˜é‡
variables:
  BINARY_NAME: agbcloud
  OSS_BUCKET: agbcloud-internal
  OSS_ENDPOINT: oss-cn-hangzhou.aliyuncs.com
  BREW_TAP_REPO: git@gitlab.alibaba-inc.com:InnoArchClub/homebrew-agbcloud.git

# æµæ°´çº¿ä½œä¸šå®šä¹‰
jobs:
  # æ„å»ºã€æ‰“åŒ…ã€ä¸Šä¼ ã€éƒ¨ç½²
  build-and-deploy:
    name: æ„å»ºå¹¶éƒ¨ç½²
    runs-on: 4-16Gi
    timeout: 60m
    steps:
      - uses: checkout
      - uses: setup-env
        inputs:
          go-version: "1.23.2"
          go-mod-cache: true
          go-cache: false
      - id: build-binaries
        name: æ„å»ºå¤šå¹³å°äºŒè¿›åˆ¶æ–‡ä»¶
        run: |
          echo "Building for all platforms..."
          export VERSION="dev-$(date +%Y%m%d-%H%M)"
          export GIT_COMMIT=$(git rev-parse --short HEAD)
          export BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "Building version: $VERSION"
          echo "Git commit: $GIT_COMMIT"
          make build-all
          ls -la bin/

      - id: create-packages
        name: åˆ›å»ºå®‰è£…åŒ…
        run: |
          echo "Creating packages..."
          export VERSION="dev-$(date +%Y%m%d-%H%M)"
          mkdir -p packages
          
          for binary in bin/*; do
            if [[ -f "$binary" ]]; then
              filename=$(basename "$binary")
              platform_arch=${filename#agbcloud-}
              
              temp_dir=$(mktemp -d)
              cp "$binary" "$temp_dir/agbcloud"
              tar -czf "packages/agbcloud-$VERSION-$platform_arch.tar.gz" -C "$temp_dir" agbcloud
              sha256sum "packages/agbcloud-$VERSION-$platform_arch.tar.gz" > "packages/agbcloud-$VERSION-$platform_arch.tar.gz.sha256"
              rm -rf "$temp_dir"
              echo "âœ“ Created package: agbcloud-$VERSION-$platform_arch.tar.gz"
            fi
          done
          
          ls -la packages/

      - id: upload-to-oss
        name: ä¸Šä¼ åˆ° OSS
        run: |
          echo "Uploading packages to OSS..."
          export VERSION="dev-$(date +%Y%m%d-%H%M)"
          
          # è®¾ç½® OSS é…ç½®å˜é‡
          export OSS_BUCKET="agbcloud-internal"
          export OSS_ENDPOINT="oss-cn-hangzhou.aliyuncs.com"
          
          # è®¾ç½® OSS å‡­è¯
          export OSS_ACCESS_KEY_ID="${{secrets.OSS_ACCESS_KEY_ID}}"
          export OSS_ACCESS_KEY_SECRET="${{secrets.OSS_ACCESS_KEY_SECRET}}"
          
          # è°ƒè¯•ä¿¡æ¯ - æ£€æŸ¥å‡­è¯é•¿åº¦å’Œå‰ç¼€ï¼ˆä¸æ³„éœ²å®Œæ•´å‡­è¯ï¼‰
          echo "=== OSS Credentials Debug Info ==="
          echo "OSS_ACCESS_KEY_ID length: ${#OSS_ACCESS_KEY_ID}"
          echo "OSS_ACCESS_KEY_SECRET length: ${#OSS_ACCESS_KEY_SECRET}"
          echo "OSS_ACCESS_KEY_ID prefix: ${OSS_ACCESS_KEY_ID:0:8}..."
          echo "OSS_ACCESS_KEY_SECRET prefix: ${OSS_ACCESS_KEY_SECRET:0:8}..."
          echo "OSS_ENDPOINT: $OSS_ENDPOINT"
          echo "OSS_BUCKET: $OSS_BUCKET"
          
          # æ£€æŸ¥å‡­è¯æ˜¯å¦è®¾ç½®
          if [[ -z "$OSS_ACCESS_KEY_ID" ]] || [[ -z "$OSS_ACCESS_KEY_SECRET" ]]; then
            echo "Error: OSS credentials not set in secrets"
            echo "OSS_ACCESS_KEY_ID is empty: $([ -z "$OSS_ACCESS_KEY_ID" ] && echo 'YES' || echo 'NO')"
            echo "OSS_ACCESS_KEY_SECRET is empty: $([ -z "$OSS_ACCESS_KEY_SECRET" ] && echo 'YES' || echo 'NO')"
            exit 1
          fi
          
          # ç½‘ç»œè¿æ¥æµ‹è¯•
          echo "=== Network Connectivity Test ==="
          echo "Testing connectivity to OSS endpoint..."
          if ping -c 3 oss-cn-hangzhou.aliyuncs.com; then
            echo "âœ“ Ping to OSS endpoint successful"
          else
            echo "âš  Ping to OSS endpoint failed"
          fi
          
          if curl -I --connect-timeout 10 https://oss-cn-hangzhou.aliyuncs.com; then
            echo "âœ“ HTTP connection to OSS endpoint successful"
          else
            echo "âš  HTTP connection to OSS endpoint failed"
          fi
          
          # å®‰è£… ossutil
          if ! command -v ossutil >/dev/null 2>&1; then
            echo "Installing ossutil..."
            curl -L "https://gosspublic.alicdn.com/ossutil/1.7.19/ossutil-v1.7.19-linux-amd64.zip" -o ossutil.zip
            unzip -q ossutil.zip
            
            # æŸ¥æ‰¾æ­£ç¡®çš„ossutiläºŒè¿›åˆ¶æ–‡ä»¶
            OSSUTIL_BINARY=$(find . -name "ossutil*" -type f | head -1)
            if [[ -z "$OSSUTIL_BINARY" ]]; then
              echo "Error: Failed to find ossutil binary after extraction"
              exit 1
            fi
            
            chmod +x "$OSSUTIL_BINARY"
            mv "$OSSUTIL_BINARY" /usr/local/bin/ossutil
            rm -f ossutil.zip
            rm -rf ossutil*/
            
            echo "âœ“ ossutil installed successfully"
          else
            echo "âœ“ ossutil already installed"
          fi
          
          # é…ç½®å¹¶ä¸Šä¼ 
          echo "=== OSS Configuration ==="
          echo "Configuring ossutil with verbose output..."
          
          # ä½¿ç”¨è¯¦ç»†æ¨¡å¼é…ç½®ossutil
          if ossutil config --endpoint="$OSS_ENDPOINT" --access-key-id="$OSS_ACCESS_KEY_ID" --access-key-secret="$OSS_ACCESS_KEY_SECRET"; then
            echo "âœ“ ossutil configuration successful"
          else
            echo "âœ— ossutil configuration failed"
            exit 1
          fi
          
          # éªŒè¯é…ç½® - ä½¿ç”¨è¯¦ç»†æ¨¡å¼
          echo "=== OSS Connection Test ==="
          echo "Testing connection to bucket: $OSS_BUCKET"
          
          if ossutil ls oss://$OSS_BUCKET/; then
            echo "âœ“ Successfully connected to OSS bucket: $OSS_BUCKET"
          else
            echo "âœ— Failed to connect to OSS bucket: $OSS_BUCKET"
            echo "Attempting to diagnose the issue..."
            
            # å°è¯•æ›´è¯¦ç»†çš„è¯Šæ–­
            echo "Testing basic OSS connectivity..."
            ossutil ls oss:// || true
            
            echo "Testing bucket existence with stat command..."
            ossutil stat oss://$OSS_BUCKET/ || true
            
            echo "Checking ossutil configuration..."
            ossutil config || true
            
            exit 1
          fi
          
          echo "OSS configuration successful, uploading packages..."
          
          for package in packages/*.tar.gz packages/*.sha256; do
            if [[ -f "$package" ]]; then
              filename=$(basename "$package")
              echo "Uploading $filename..."
              
              if ossutil cp "$package" "oss://$OSS_BUCKET/agbcloud/releases/$filename" --force; then
                if ossutil set-acl "oss://$OSS_BUCKET/agbcloud/releases/$filename" public-read; then
                  echo "âœ“ Uploaded and set public: $filename"
                else
                  echo "âš  Uploaded but failed to set ACL: $filename"
                fi
              else
                echo "âœ— Failed to upload: $filename"
                exit 1
              fi
            fi
          done

      - id: update-homebrew-tap
        name: æ›´æ–° Homebrew Tap
        run: |
          echo "Updating Homebrew Tap..."
          export VERSION="dev-$(date +%Y%m%d-%H%M)"
          export GIT_COMMIT=$(git rev-parse --short HEAD)
          export TIMESTAMP=$(date +%Y%m%d-%H%M)
          export SANITIZED_TIMESTAMP=$(echo "$TIMESTAMP" | tr -d '-')
          
          echo "=== SSH Key Setup ==="
          # è®¾ç½®SSHå¯†é’¥
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # æ£€æŸ¥SSHç§é’¥æ˜¯å¦è®¾ç½®
          if [[ -z "${{secrets.AONE_CI_DEPLOY_KEY}}" ]]; then
            echo "Error: AONE_CI_DEPLOY_KEY not set in secrets"
            exit 1
          fi
          
          # å°†ç§é’¥å†™å…¥æ–‡ä»¶
          echo "${{secrets.AONE_CI_DEPLOY_KEY}}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # éªŒè¯ç§é’¥æ–‡ä»¶ï¼ˆä¸æ˜¾ç¤ºå†…å®¹ï¼‰
          if [[ -f ~/.ssh/id_rsa ]]; then
            echo "âœ“ SSH private key file created"
            echo "Private key file size: $(wc -c < ~/.ssh/id_rsa) bytes"
          else
            echo "âœ— Failed to create SSH private key file"
            exit 1
          fi
          
          # æ£€æŸ¥ç§é’¥æ ¼å¼å¹¶è½¬æ¢å¦‚æœéœ€è¦
          echo "Checking SSH key format..."
          KEY_HEADER=$(head -1 ~/.ssh/id_rsa)
          echo "Key header: $KEY_HEADER"
          
          if echo "$KEY_HEADER" | grep -q "BEGIN OPENSSH PRIVATE KEY"; then
            echo "Detected OpenSSH format key, converting to PEM format..."
            # å¤‡ä»½åŸå§‹å¯†é’¥
            cp ~/.ssh/id_rsa ~/.ssh/id_rsa.backup
            # è½¬æ¢ä¸ºPEMæ ¼å¼ï¼ˆä¸è®¾ç½®å¯†ç ï¼‰
            if ssh-keygen -p -m PEM -f ~/.ssh/id_rsa -P "" -N ""; then
              echo "âœ“ Successfully converted key to PEM format"
              echo "New key header: $(head -1 ~/.ssh/id_rsa)"
            else
              echo "âš  Key conversion failed, restoring original format"
              cp ~/.ssh/id_rsa.backup ~/.ssh/id_rsa
            fi
          elif echo "$KEY_HEADER" | grep -q "BEGIN RSA PRIVATE KEY\|BEGIN PRIVATE KEY"; then
            echo "âœ“ Key is already in PEM format"
          else
            echo "âš  Unknown key format: $KEY_HEADER"
            echo "Proceeding with original format..."
          fi
          
          # éªŒè¯ç§é’¥è¯­æ³•
          if ssh-keygen -y -f ~/.ssh/id_rsa > /dev/null 2>&1; then
            echo "âœ“ SSH private key syntax is valid"
          else
            echo "âœ— SSH private key syntax validation failed"
            echo "Key format issue detected. Please check the private key format."
            exit 1
          fi
          
          # åˆ›å»ºSSHé…ç½®æ–‡ä»¶
          cat > ~/.ssh/config << EOF
          Host gitlab.alibaba-inc.com
              HostName gitlab.alibaba-inc.com
              User git
              IdentityFile ~/.ssh/id_rsa
              StrictHostKeyChecking no
              UserKnownHostsFile /dev/null
          EOF
          chmod 600 ~/.ssh/config
          
          # å¯åŠ¨ssh-agentå¹¶æ·»åŠ å¯†é’¥
          eval "$(ssh-agent -s)"
          
          # æ·»åŠ å¯†é’¥åˆ°ssh-agent
          echo "Adding SSH key to ssh-agent..."
          if ssh-add ~/.ssh/id_rsa; then
            echo "âœ“ SSH key added to ssh-agent successfully"
          else
            echo "âœ— Failed to add SSH key to ssh-agent"
            echo "Trying to add key with verbose output..."
            ssh-add -v ~/.ssh/id_rsa || true
          fi
          
          # åˆ—å‡ºssh-agentä¸­çš„å¯†é’¥
          echo "Keys in ssh-agent:"
          ssh-add -l || echo "No keys in ssh-agent"
          
          # æµ‹è¯•SSHè¿æ¥
          echo "Testing SSH connection to GitLab..."
          echo "Using verbose SSH connection test..."
          
          # ä½¿ç”¨verboseæ¨¡å¼æµ‹è¯•è¿æ¥
          if ssh -v -T git@gitlab.alibaba-inc.com 2>&1 | tee /tmp/ssh_test.log; then
            echo "âœ“ SSH connection successful"
          else
            SSH_EXIT_CODE=$?
            echo "SSH connection test exit code: $SSH_EXIT_CODE"
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯GitLabçš„æ­£å¸¸å“åº”
            if grep -q "Welcome to GitLab" /tmp/ssh_test.log || grep -q "successfully authenticated" /tmp/ssh_test.log; then
              echo "âœ“ SSH authentication successful (GitLab connection confirmed)"
            else
              echo "âœ— SSH connection failed"
              echo "SSH test log:"
              cat /tmp/ssh_test.log
              exit 1
            fi
          fi
          
          echo "=== Homebrew Tap Update Debug Info ==="
          echo "VERSION: $VERSION"
          echo "GIT_COMMIT: $GIT_COMMIT"
          echo "TIMESTAMP: $TIMESTAMP"
          echo "SANITIZED_TIMESTAMP: $SANITIZED_TIMESTAMP"
          echo "Current directory: $(pwd)"
          echo "Available packages:"
          ls -la packages/ || echo "No packages directory found"
          
          # è®¾ç½® Homebrew Tap ä»“åº“åœ°å€
          export BREW_TAP_REPO="git@gitlab.alibaba-inc.com:InnoArchClub/homebrew-agbcloud.git"
          
          # å…‹éš† tap ä»“åº“
          echo "=== Git Repository Clone ==="
          echo "Cloning Homebrew Tap repository: $BREW_TAP_REPO"
          
          if git clone "$BREW_TAP_REPO" homebrew-agbcloud; then
            echo "âœ“ Successfully cloned tap repository via SSH"
          else
            echo "âœ— Failed to clone tap repository via SSH"
            echo "SSH key setup may have failed or repository access denied"
            exit 1
          fi
          
          cd homebrew-agbcloud
          
          # æ£€æŸ¥å½“å‰åˆ†æ”¯
          echo "Current branch: $(git branch --show-current)"
          echo "Available branches:"
          git branch -a
          
          # é…ç½® git
          git config user.name "Aone CICD Bot"
          git config user.email "cicd@alibaba-inc.com"
          
          # è·å– SHA256 å€¼
          get_sha256() {
              local platform_arch=$1
              local sha256_file="../packages/agbcloud-$VERSION-$platform_arch.tar.gz.sha256"
              if [[ -f "$sha256_file" ]]; then
                  cut -d' ' -f1 "$sha256_file"
              else
                  echo "MISSING_SHA256"
              fi
          }
          
          DARWIN_AMD64_SHA256=$(get_sha256 "darwin-amd64")
          DARWIN_ARM64_SHA256=$(get_sha256 "darwin-arm64")
          LINUX_AMD64_SHA256=$(get_sha256 "linux-amd64")
          LINUX_ARM64_SHA256=$(get_sha256 "linux-arm64")
          
          # ç”Ÿæˆ Formula
          echo "Creating Formula directory if it doesn't exist..."
          mkdir -p Formula
          
          FORMULA_FILE="Formula/agbcloud@dev-$TIMESTAMP.rb"
          echo "Creating Formula file: $FORMULA_FILE"
          
          cat > "$FORMULA_FILE" << EOF
          class AgbcloudAT${SANITIZED_TIMESTAMP} < Formula
            desc "AgbCloud CLI - Test Build $TIMESTAMP"
            homepage "https://alibaba-inc.com/agbcloud"
            version "$VERSION"
          
            if OS.mac?
              if Hardware::CPU.arm?
                url "https://agbcloud-internal.oss-cn-hangzhou.aliyuncs.com/agbcloud/releases/agbcloud-$VERSION-darwin-arm64.tar.gz"
                sha256 "$DARWIN_ARM64_SHA256"
              else
                url "https://agbcloud-internal.oss-cn-hangzhou.aliyuncs.com/agbcloud/releases/agbcloud-$VERSION-darwin-amd64.tar.gz"
                sha256 "$DARWIN_AMD64_SHA256"
              end
            elsif OS.linux?
              if Hardware::CPU.arm?
                url "https://agbcloud-internal.oss-cn-hangzhou.aliyuncs.com/agbcloud/releases/agbcloud-$VERSION-linux-arm64.tar.gz"
                sha256 "$LINUX_ARM64_SHA256"
              else
                url "https://agbcloud-internal.oss-cn-hangzhou.aliyuncs.com/agbcloud/releases/agbcloud-$VERSION-linux-amd64.tar.gz"
                sha256 "$LINUX_AMD64_SHA256"
              end
            end
          
            def install
              bin.install "agbcloud"
            end
          
            test do
              system "#{bin}/agbcloud", "version"
            end
          
            def caveats
              <<~EOS
                This is a test build of AgbCloud CLI.
                Build timestamp: $TIMESTAMP
                Git commit: $GIT_COMMIT
                
                To switch between versions:
                  brew unlink agbcloud@${SANITIZED_TIMESTAMP}
                  brew link agbcloud@other-version
              EOS
            end
          end
          EOF
          
          # æäº¤æ›´æ”¹
          echo "Adding Formula file to git..."
          git add "$FORMULA_FILE"
          
          echo "Committing changes..."
          git commit -m "Add test build agbcloud@dev-$TIMESTAMP

          Version: $VERSION
          Git commit: $GIT_COMMIT
          Build timestamp: $TIMESTAMP"
          
          # æ£€æŸ¥å½“å‰åˆ†æ”¯å¹¶æ¨é€
          echo "=== Git Push ==="
          CURRENT_BRANCH=$(git branch --show-current)
          echo "Current branch: $CURRENT_BRANCH"
          echo "Remote URL: $(git remote get-url origin)"
          
          # ç¡®ä¿ä½¿ç”¨SSH URL
          git remote set-url origin "$BREW_TAP_REPO"
          echo "Updated remote URL to: $(git remote get-url origin)"
          
          echo "Pushing to branch: $CURRENT_BRANCH"
          if git push origin "$CURRENT_BRANCH"; then
            echo "âœ“ Successfully pushed to $CURRENT_BRANCH via SSH"
          else
            echo "âœ— Failed to push to $CURRENT_BRANCH, trying master..."
            if git push origin master; then
              echo "âœ“ Successfully pushed to master via SSH"
            else
              echo "âœ— Failed to push to both $CURRENT_BRANCH and master"
              echo "Checking git status and remote configuration..."
              git status
              git remote -v
              exit 1
            fi
          fi
          
          echo "âœ… Homebrew Tap updated successfully!"
          echo "Users can install with: brew install agbcloud@dev-$TIMESTAMP"

      - id: send-notification
        name: å‘é€é€šçŸ¥
        run: |
          export VERSION="dev-$(date +%Y%m%d-%H%M)"
          export TIMESTAMP=$(date +%Y%m%d-%H%M)
          
          echo "ğŸ‰ AgbCloud CLI æµ‹è¯•åŒ…æ„å»ºå®Œæˆï¼
          
          ğŸ“¦ ç‰ˆæœ¬: $VERSION
          ğŸ•’ æ—¶é—´æˆ³: $TIMESTAMP
          ğŸ“ Git æäº¤: $(git rev-parse --short HEAD)
          
          ğŸº å®‰è£…å‘½ä»¤:
          brew install agbcloud@dev-$TIMESTAMP" 