# AgbCloud CLI Homebrew Tap æµ‹è¯•åŒ…åˆ†å‘æµæ°´çº¿
name: AgbCloud CLI Test Package Distribution

# è‡ªåŠ¨è§¦å‘æ¡ä»¶
triggers:
  push:
    branches:
      - master
      - main

# å…¨å±€å˜é‡
variables:
  BINARY_NAME: agbcloud
  OSS_BUCKET: agbcloud-internal
  OSS_ENDPOINT: oss-cn-hangzhou.aliyuncs.com
  BREW_TAP_REPO: git@gitlab.alibaba-inc.com:InnoArchClub/homebrew-agbcloud.git

# æµæ°´çº¿ä½œä¸šå®šä¹‰
jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: 2-8Gi
    timeout: 15m
    steps:
      - uses: checkout
      - uses: setup-env
        inputs:
          go-version: "1.23.2"
          go-mod-cache: true
          go-cache: false
      
      - id: install-lint-dependencies
        name: å®‰è£…ä»£ç æ£€æŸ¥ä¾èµ–
        run: |
          echo "Installing linting dependencies..."
          go mod download
          go mod tidy
          
          # Install golangci-lint for linting
          echo "Installing golangci-lint..."
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.55.2
          export PATH=$PATH:$(go env GOPATH)/bin
          echo "golangci-lint version: $(golangci-lint --version)"
      
      - id: code-formatting-check
        name: ä»£ç æ ¼å¼æ£€æŸ¥
        run: |
          echo "Checking code formatting..."
          if ! go fmt ./...; then
            echo "âŒ Code formatting check failed"
            echo "Please run 'go fmt ./...' to fix formatting issues"
            exit 1
          fi
          echo "âœ… Code formatting check passed"
      
      - id: static-analysis
        name: é™æ€ä»£ç åˆ†æ
        run: |
          echo "Running static code analysis..."
          export PATH=$PATH:$(go env GOPATH)/bin
          
          if ! golangci-lint run --timeout=5m; then
            echo "âŒ Static analysis failed"
            echo "Please fix the linting issues before proceeding"
            exit 1
          fi
          echo "âœ… Static analysis passed"

  # å•å…ƒæµ‹è¯•
  unit-tests:
    name: å•å…ƒæµ‹è¯•
    runs-on: 2-8Gi
    timeout: 20m
    needs: [code-quality]
    steps:
      - uses: checkout
      - uses: setup-env
        inputs:
          go-version: "1.23.2"
          go-mod-cache: true
          go-cache: false
      
      - id: install-test-dependencies
        name: å®‰è£…æµ‹è¯•ä¾èµ–
        run: |
          echo "Installing test dependencies..."
          go mod download
          go mod tidy
      
      - id: run-unit-tests
        name: è¿è¡Œå•å…ƒæµ‹è¯•
        run: |
          echo "Running unit tests..."
          
          # Run unit tests with coverage
          if ! make test-unit; then
            echo "âŒ Unit tests failed"
            exit 1
          fi
          echo "âœ… Unit tests passed"
      
      - id: generate-coverage
        name: ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
        run: |
          echo "Generating coverage report..."
          if ! make test-coverage; then
            echo "âš ï¸ Coverage report generation failed, but continuing..."
          else
            echo "âœ… Coverage report generated"
          fi
          
          # Display test summary
          echo ""
          echo "ğŸ“Š Test Summary:"
          go test -v ./test/unit/... 2>/dev/null | grep -E "(PASS|FAIL|RUN)" | tail -10 || true

  # æ„å»ºå’Œéƒ¨ç½²
  build-and-deploy:
    name: æ„å»ºå’Œéƒ¨ç½²
    runs-on: 4-16Gi
    timeout: 45m
    needs: [code-quality, unit-tests]
    steps:
      - uses: checkout
      - uses: setup-env
        inputs:
          go-version: "1.23.2"
          go-mod-cache: true
          go-cache: false
      
      - id: build-binaries
        name: æ„å»ºå¤šå¹³å°äºŒè¿›åˆ¶æ–‡ä»¶
        run: |
          echo "Building for all platforms..."
          export VERSION="dev-$(date +%Y%m%d-%H%M)"
          export GIT_COMMIT=$(git rev-parse --short HEAD)
          export BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "Building version: $VERSION"
          echo "Git commit: $GIT_COMMIT"
          make build-all
          ls -la bin/

      - id: create-packages
        name: åˆ›å»ºå®‰è£…åŒ…
        run: |
          echo "Creating packages..."
          export VERSION="dev-$(date +%Y%m%d-%H%M)"
          mkdir -p packages
          
          for binary in bin/*; do
            if [[ -f "$binary" ]]; then
              filename=$(basename "$binary")
              platform_arch=${filename#agbcloud-}
              
              temp_dir=$(mktemp -d)
              cp "$binary" "$temp_dir/agbcloud"
              tar -czf "packages/agbcloud-$VERSION-$platform_arch.tar.gz" -C "$temp_dir" agbcloud
              sha256sum "packages/agbcloud-$VERSION-$platform_arch.tar.gz" > "packages/agbcloud-$VERSION-$platform_arch.tar.gz.sha256"
              rm -rf "$temp_dir"
              echo "âœ“ Created package: agbcloud-$VERSION-$platform_arch.tar.gz"
            fi
          done
          
          ls -la packages/

      - id: upload-to-oss
        name: ä¸Šä¼ åˆ° OSS
        run: |
          echo "Uploading packages to OSS..."
          export VERSION="dev-$(date +%Y%m%d-%H%M)"
          
          # è®¾ç½® OSS é…ç½®å˜é‡
          export OSS_BUCKET="agbcloud-internal"
          export OSS_ENDPOINT="oss-cn-hangzhou.aliyuncs.com"
          
          # è®¾ç½® OSS å‡­è¯
          export OSS_ACCESS_KEY_ID="${{secrets.OSS_ACCESS_KEY_ID}}"
          export OSS_ACCESS_KEY_SECRET="${{secrets.OSS_ACCESS_KEY_SECRET}}"
          
          # è°ƒè¯•ä¿¡æ¯ - æ£€æŸ¥å‡­è¯é•¿åº¦å’Œå‰ç¼€ï¼ˆä¸æ³„éœ²å®Œæ•´å‡­è¯ï¼‰
          echo "=== OSS Credentials Debug Info ==="
          echo "OSS_ACCESS_KEY_ID length: ${#OSS_ACCESS_KEY_ID}"
          echo "OSS_ACCESS_KEY_SECRET length: ${#OSS_ACCESS_KEY_SECRET}"
          echo "OSS_ACCESS_KEY_ID prefix: ${OSS_ACCESS_KEY_ID:0:8}..."
          echo "OSS_ACCESS_KEY_SECRET prefix: ${OSS_ACCESS_KEY_SECRET:0:8}..."
          echo "OSS_ENDPOINT: $OSS_ENDPOINT"
          echo "OSS_BUCKET: $OSS_BUCKET"
          
          # æ£€æŸ¥å‡­è¯æ˜¯å¦è®¾ç½®
          if [[ -z "$OSS_ACCESS_KEY_ID" ]] || [[ -z "$OSS_ACCESS_KEY_SECRET" ]]; then
            echo "Error: OSS credentials not set in secrets"
            echo "OSS_ACCESS_KEY_ID is empty: $([ -z "$OSS_ACCESS_KEY_ID" ] && echo 'YES' || echo 'NO')"
            echo "OSS_ACCESS_KEY_SECRET is empty: $([ -z "$OSS_ACCESS_KEY_SECRET" ] && echo 'YES' || echo 'NO')"
            exit 1
          fi
          
          # ç½‘ç»œè¿æ¥æµ‹è¯•
          echo "=== Network Connectivity Test ==="
          echo "Testing connectivity to OSS endpoint..."
          if ping -c 3 oss-cn-hangzhou.aliyuncs.com; then
            echo "âœ“ Ping to OSS endpoint successful"
          else
            echo "âš  Ping to OSS endpoint failed"
          fi
          
          if curl -I --connect-timeout 10 https://oss-cn-hangzhou.aliyuncs.com; then
            echo "âœ“ HTTP connection to OSS endpoint successful"
          else
            echo "âš  HTTP connection to OSS endpoint failed"
          fi
          
          # å®‰è£… ossutil
          if ! command -v ossutil >/dev/null 2>&1; then
            echo "Installing ossutil..."
            curl -L "https://gosspublic.alicdn.com/ossutil/1.7.19/ossutil-v1.7.19-linux-amd64.zip" -o ossutil.zip
            unzip -q ossutil.zip
            
            # æŸ¥æ‰¾æ­£ç¡®çš„ossutiläºŒè¿›åˆ¶æ–‡ä»¶
            OSSUTIL_BINARY=$(find . -name "ossutil*" -type f | head -1)
            if [[ -z "$OSSUTIL_BINARY" ]]; then
              echo "Error: Failed to find ossutil binary after extraction"
              exit 1
            fi
            
            chmod +x "$OSSUTIL_BINARY"
            mv "$OSSUTIL_BINARY" /usr/local/bin/ossutil
            rm -f ossutil.zip
            rm -rf ossutil*/
            
            echo "âœ“ ossutil installed successfully"
          else
            echo "âœ“ ossutil already installed"
          fi
          
          # é…ç½®å¹¶ä¸Šä¼ 
          echo "=== OSS Configuration ==="
          echo "Configuring ossutil with verbose output..."
          
          # ä½¿ç”¨è¯¦ç»†æ¨¡å¼é…ç½®ossutil
          if ossutil config --endpoint="$OSS_ENDPOINT" --access-key-id="$OSS_ACCESS_KEY_ID" --access-key-secret="$OSS_ACCESS_KEY_SECRET"; then
            echo "âœ“ ossutil configuration successful"
          else
            echo "âœ— ossutil configuration failed"
            exit 1
          fi
          
          # éªŒè¯é…ç½® - ä½¿ç”¨è¯¦ç»†æ¨¡å¼
          echo "=== OSS Connection Test ==="
          echo "Testing connection to bucket: $OSS_BUCKET"
          
          if ossutil ls oss://$OSS_BUCKET/; then
            echo "âœ“ Successfully connected to OSS bucket: $OSS_BUCKET"
          else
            echo "âœ— Failed to connect to OSS bucket: $OSS_BUCKET"
            echo "Attempting to diagnose the issue..."
            
            # å°è¯•æ›´è¯¦ç»†çš„è¯Šæ–­
            echo "Testing basic OSS connectivity..."
            ossutil ls oss:// || true
            
            echo "Testing bucket existence with stat command..."
            ossutil stat oss://$OSS_BUCKET/ || true
            
            echo "Checking ossutil configuration..."
            ossutil config || true
            
            exit 1
          fi
          
          echo "OSS configuration successful, uploading packages..."
          
          for package in packages/*.tar.gz packages/*.sha256; do
            if [[ -f "$package" ]]; then
              filename=$(basename "$package")
              echo "Uploading $filename..."
              
              if ossutil cp "$package" "oss://$OSS_BUCKET/agbcloud/releases/$filename" --force; then
                if ossutil set-acl "oss://$OSS_BUCKET/agbcloud/releases/$filename" public-read; then
                  echo "âœ“ Uploaded and set public: $filename"
                else
                  echo "âš  Uploaded but failed to set ACL: $filename"
                fi
              else
                echo "âœ— Failed to upload: $filename"
                exit 1
              fi
            fi
          done

      - id: update-homebrew-tap
        name: æ›´æ–° Homebrew Tap
        run: |
          echo "Updating Homebrew Tap..."
          export VERSION="dev-$(date +%Y%m%d-%H%M)"
          export GIT_COMMIT=$(git rev-parse --short HEAD)
          export TIMESTAMP=$(date +%Y%m%d-%H%M)
          export SANITIZED_TIMESTAMP=$(echo "$TIMESTAMP" | tr -d '-')
          
          echo "Setting up SSH key..."
          # è®¾ç½®SSHå¯†é’¥
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # æ£€æŸ¥SSHç§é’¥æ˜¯å¦è®¾ç½®
          if [[ -z "${{secrets.AONE_CI_DEPLOY_KEY}}" ]]; then
            echo "Error: AONE_CI_DEPLOY_KEY not set in secrets"
            exit 1
          fi
          
          # å°†ç§é’¥å†™å…¥æ–‡ä»¶
          echo "${{secrets.AONE_CI_DEPLOY_KEY}}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # æ£€æŸ¥ç§é’¥æ ¼å¼å¹¶è½¬æ¢å¦‚æœéœ€è¦
          if head -1 ~/.ssh/id_rsa | grep -q "BEGIN OPENSSH PRIVATE KEY"; then
            # è½¬æ¢ä¸ºPEMæ ¼å¼ï¼ˆä¸è®¾ç½®å¯†ç ï¼‰
            ssh-keygen -p -m PEM -f ~/.ssh/id_rsa -P "" -N "" > /dev/null 2>&1 || true
          fi
          
          # åˆ›å»ºSSHé…ç½®æ–‡ä»¶
          cat > ~/.ssh/config << EOF
          Host gitlab.alibaba-inc.com
              HostName gitlab.alibaba-inc.com
              User git
              IdentityFile ~/.ssh/id_rsa
              StrictHostKeyChecking no
              UserKnownHostsFile /dev/null
          EOF
          chmod 600 ~/.ssh/config
          
          # å¯åŠ¨ssh-agentå¹¶æ·»åŠ å¯†é’¥
          eval "$(ssh-agent -s)" > /dev/null
          ssh-add ~/.ssh/id_rsa > /dev/null 2>&1
          

          
          # è®¾ç½® Homebrew Tap ä»“åº“åœ°å€
          export BREW_TAP_REPO="git@gitlab.alibaba-inc.com:InnoArchClub/homebrew-agbcloud.git"
          
          # å…‹éš† tap ä»“åº“
          echo "Cloning Homebrew Tap repository..."
          
          if git clone "$BREW_TAP_REPO" homebrew-agbcloud > /dev/null 2>&1; then
            echo "âœ“ Successfully cloned tap repository"
          else
            echo "âœ— Failed to clone tap repository"
            exit 1
          fi
          
          cd homebrew-agbcloud
          
          # é…ç½® git
          git config user.name "Aone CICD Bot"
          git config user.email "cicd@alibaba-inc.com"
          
          # è·å– SHA256 å€¼
          get_sha256() {
              local platform_arch=$1
              local sha256_file="../packages/agbcloud-$VERSION-$platform_arch.tar.gz.sha256"
              if [[ -f "$sha256_file" ]]; then
                  cut -d' ' -f1 "$sha256_file"
              else
                  echo "MISSING_SHA256"
              fi
          }
          
          DARWIN_AMD64_SHA256=$(get_sha256 "darwin-amd64")
          DARWIN_ARM64_SHA256=$(get_sha256 "darwin-arm64")
          LINUX_AMD64_SHA256=$(get_sha256 "linux-amd64")
          LINUX_ARM64_SHA256=$(get_sha256 "linux-arm64")
          
          # ç”Ÿæˆ Formula
          echo "Creating Formula file..."
          mkdir -p Formula
          
          # ä½¿ç”¨ç®€åŒ–çš„å‘½åæ–¹å¼ï¼Œé¿å…@ç¬¦å·é—®é¢˜
          FORMULA_FILE="Formula/agbcloud-dev-$TIMESTAMP.rb"
          FORMULA_CLASS_NAME="AgbcloudDev${SANITIZED_TIMESTAMP}"
          
          cat > "$FORMULA_FILE" << EOF
          class ${FORMULA_CLASS_NAME} < Formula
            desc "AgbCloud CLI - Test Build $TIMESTAMP"
            homepage "https://alibaba-inc.com/agbcloud"
            version "$VERSION"
          
            if OS.mac?
              if Hardware::CPU.arm?
                url "https://agbcloud-internal.oss-cn-hangzhou.aliyuncs.com/agbcloud/releases/agbcloud-$VERSION-darwin-arm64.tar.gz"
                sha256 "$DARWIN_ARM64_SHA256"
              else
                url "https://agbcloud-internal.oss-cn-hangzhou.aliyuncs.com/agbcloud/releases/agbcloud-$VERSION-darwin-amd64.tar.gz"
                sha256 "$DARWIN_AMD64_SHA256"
              end
            elsif OS.linux?
              if Hardware::CPU.arm?
                url "https://agbcloud-internal.oss-cn-hangzhou.aliyuncs.com/agbcloud/releases/agbcloud-$VERSION-linux-arm64.tar.gz"
                sha256 "$LINUX_ARM64_SHA256"
              else
                url "https://agbcloud-internal.oss-cn-hangzhou.aliyuncs.com/agbcloud/releases/agbcloud-$VERSION-linux-amd64.tar.gz"
                sha256 "$LINUX_AMD64_SHA256"
              end
            end
          
            def install
              bin.install "agbcloud"
            end
          
            test do
              system "#{bin}/agbcloud", "version"
            end
          
            def caveats
              <<~EOS
                This is a test build of AgbCloud CLI.
                Build timestamp: $TIMESTAMP
                Git commit: $GIT_COMMIT
                
                ğŸš€ Quick Start:
                  agbcloud version        # Check version
                  agbcloud --help         # Show help
                  agbcloud login          # Login to AgbCloud
                
                ğŸ“ Note: The executable is named 'agbcloud', not 'agbcloud-dev-${TIMESTAMP}'
                
                ğŸ”„ To switch between versions:
                  brew unlink agbcloud-dev-${TIMESTAMP}
                  brew link agbcloud-dev-other-version
              EOS
            end
          end
          EOF
          
          # æäº¤æ›´æ”¹
          echo "Committing and pushing changes..."
          git add "$FORMULA_FILE"
          git commit -m "Add test build agbcloud-dev-$TIMESTAMP

          Version: $VERSION
          Git commit: $GIT_COMMIT
          Build timestamp: $TIMESTAMP" > /dev/null
          
          # æ¨é€æ›´æ”¹
          CURRENT_BRANCH=$(git branch --show-current)
          if git push origin "$CURRENT_BRANCH" > /dev/null 2>&1; then
            echo "âœ“ Successfully pushed to $CURRENT_BRANCH"
          else
            echo "âœ— Failed to push changes"
            exit 1
          fi
          
          echo "âœ… Homebrew Tap updated successfully!"
          echo ""
          echo "ğŸ“‹ Installation Instructions:"
          echo "1. Add tap (only needed once):"
          echo "   brew tap InnoArchClub/agbcloud https://gitlab.alibaba-inc.com/InnoArchClub/homebrew-agbcloud.git"
          echo ""
          echo "2. Update tap information:"
          echo "   brew update"
          echo ""
          echo "3. Install this version:"
          echo "   brew install agbcloud-dev-$TIMESTAMP"
          echo ""
          echo "4. Force link to latest version (recommended):"
          echo "   brew link --overwrite agbcloud-dev-$TIMESTAMP"
          echo ""
          echo "5. Use the CLI (executable name is 'agbcloud'):"
          echo "   agbcloud version"
          echo "   agbcloud --help"
          echo ""
          echo "ğŸ”„ Version Switching:"
          echo "   # Switch to this test version (force overwrite):"
          echo "   brew link --overwrite agbcloud-dev-$TIMESTAMP"
          echo ""
          echo "   # Or manual unlink then link:"
          echo "   brew unlink agbcloud agbcloud-dev-* 2>/dev/null || true"
          echo "   brew link agbcloud-dev-$TIMESTAMP"
          echo ""
          echo "   # Switch back to official version:"
          echo "   brew unlink agbcloud-dev-* 2>/dev/null || true"
          echo "   brew link --overwrite agbcloud"

      - id: send-notification
        name: å‘é€é€šçŸ¥
        run: |
          export VERSION="dev-$(date +%Y%m%d-%H%M)"
          export TIMESTAMP=$(date +%Y%m%d-%H%M)
          
          echo "ğŸ‰ AgbCloud CLI æµ‹è¯•åŒ…æ„å»ºå®Œæˆï¼
          
          ğŸ“¦ ç‰ˆæœ¬: $VERSION
          ğŸ•’ æ—¶é—´æˆ³: $TIMESTAMP
          ğŸ“ Git æäº¤: $(git rev-parse --short HEAD)
          âœ… è´¨é‡æ£€æŸ¥: ä»£ç æ ¼å¼ âœ“ é™æ€åˆ†æ âœ“ å•å…ƒæµ‹è¯• âœ“"
          
          ğŸº å®‰è£…å‘½ä»¤:
          1. æ·»åŠ  tap (ä»…é¦–æ¬¡éœ€è¦):
             brew tap InnoArchClub/agbcloud https://gitlab.alibaba-inc.com/InnoArchClub/homebrew-agbcloud.git
          
          2. æ›´æ–° tap ä¿¡æ¯:
             brew update
          
          3. å®‰è£…æ­¤ç‰ˆæœ¬:
             brew install agbcloud-dev-$TIMESTAMP
          
          4. å¼ºåˆ¶é“¾æ¥åˆ°æœ€æ–°ç‰ˆæœ¬ (æ¨è):
             brew link --overwrite agbcloud-dev-$TIMESTAMP
          
          5. ä½¿ç”¨å‘½ä»¤:
             agbcloud version
             agbcloud --help
          
          ğŸ”„ ç‰ˆæœ¬åˆ‡æ¢:
          # åˆ‡æ¢åˆ°æ­¤æµ‹è¯•ç‰ˆæœ¬ (å¼ºåˆ¶è¦†ç›–)
          brew link --overwrite agbcloud-dev-$TIMESTAMP
          
          # æˆ–è€…æ‰‹åŠ¨è§£é™¤é“¾æ¥åå†é“¾æ¥
          brew unlink agbcloud agbcloud-dev-* 2>/dev/null || true
          brew link agbcloud-dev-$TIMESTAMP
          
          # åˆ‡æ¢åˆ°æ­£å¼ç‰ˆæœ¬ (å¦‚æœå·²å®‰è£…)
          brew unlink agbcloud-dev-* 2>/dev/null || true
          brew link --overwrite agbcloud
          
          # æŸ¥çœ‹å·²å®‰è£…çš„ç‰ˆæœ¬
          brew list | grep agbcloud
          
          # å¸è½½æµ‹è¯•ç‰ˆæœ¬
          brew uninstall agbcloud-dev-$TIMESTAMP" 