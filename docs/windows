# PowerShell script to download and install AgbCloud CLI binary from GitHub Releases

param(
    [string]$Version = "",
    [string]$Architecture = "",
    [string]$InstallPath = "",
    [switch]$Help
)

# Show help information
if ($Help) {
    Write-Host "AgbCloud CLI Installation Script"
    Write-Host ""
    Write-Host "Usage:"
    Write-Host "  powershell -Command `"irm https://agbcloud.github.io/agbcloud-cli/windows | iex`""
    Write-Host ""
    Write-Host "Options:"
    Write-Host "  -Version <version>      Specify version to install (e.g., 'v1.0.0', 'latest')"
    Write-Host "  -Architecture <arch>    Specify architecture ('amd64' or 'arm64')"
    Write-Host "  -InstallPath <path>     Specify custom installation directory"
    Write-Host "  -Help                   Show this help message"
    Write-Host ""
    Write-Host "Environment Variables:"
    Write-Host "  AGBCLOUD_VERSION        Default version to install"
    Write-Host "  AGBCLOUD_PATH           Default installation directory"
    Write-Host ""
    Write-Host "Examples:"
    Write-Host "  powershell -Command `"irm https://agbcloud.github.io/agbcloud-cli/windows | iex`""
    Write-Host "  powershell -Command `"irm https://agbcloud.github.io/agbcloud-cli/windows| iex`" -Version v1.0.0"
    exit 0
}

# Determine architecture
if (-not $Architecture) {
    $Architecture = if ($env:PROCESSOR_ARCHITECTURE -eq "AMD64") { 
        "amd64" 
    } elseif ($env:PROCESSOR_ARCHITECTURE -eq "ARM64") { 
        "arm64" 
    } else { 
        "amd64" 
    }
}

# GitHub repository information
$repoOwner = "{{REPO_OWNER}}"
$repoName = "{{REPO_NAME}}"
$githubApiUrl = "https://api.github.com/repos/$repoOwner/$repoName"

# Installation directory
$destination = if ($InstallPath) { 
    $InstallPath 
} elseif ($env:AGBCLOUD_PATH) {
    $env:AGBCLOUD_PATH
} else {
    "$env:LOCALAPPDATA\agbcloud"
}

Write-Host "[INFO] Installing AgbCloud CLI..."
Write-Host ""

# Determine version with parameter priority
$version = if ($Version) { 
    $Version 
} elseif ($env:AGBCLOUD_VERSION) { 
    $env:AGBCLOUD_VERSION 
} else { 
    "latest"  # Default to latest version
}

# Get latest version if needed
if ($version -eq "latest") {
    try {
        Write-Host "[INFO] Fetching latest version from GitHub..."
        
        # Create headers to avoid 403 errors
        $headers = @{
            'User-Agent' = 'AgbCloud-CLI-Installer/1.0 PowerShell'
            'Accept' = 'application/vnd.github.v3+json'
        }
        
        # Add timeout and retry logic
        $maxRetries = 3
        $retryDelay = 2
        
        for ($i = 1; $i -le $maxRetries; $i++) {
            try {
                Write-Host "[INFO] Attempt $i/$maxRetries to fetch latest release..."
                $latestRelease = Invoke-RestMethod -Uri "$githubApiUrl/releases/latest" -Headers $headers -TimeoutSec 30 -ErrorAction Stop
                $version = $latestRelease.tag_name
                Write-Host "[INFO] Latest version: $version"
                break
            } catch {
                if ($i -eq $maxRetries) {
                    throw $_
                }
                Write-Host "[WARN] Attempt $i failed: $($_.Exception.Message). Retrying in $retryDelay seconds..."
                Start-Sleep -Seconds $retryDelay
                $retryDelay *= 2  # Exponential backoff
            }
        }
    } catch {
        Write-Host "[WARN] Could not fetch latest version, trying to get available releases..."
        try {
            # Try to get all releases and pick the latest available version
            Write-Host "[INFO] Trying to fetch all releases..."
            
            # Create headers for the fallback request
            $headers = @{
                'User-Agent' = 'AgbCloud-CLI-Installer/1.0 PowerShell'
                'Accept' = 'application/vnd.github.v3+json'
            }
            
            # Retry logic for all releases
            for ($i = 1; $i -le 3; $i++) {
                try {
                    Write-Host "[INFO] Attempt $i/3 to fetch all releases..."
                    $allReleases = Invoke-RestMethod -Uri "$githubApiUrl/releases" -Headers $headers -TimeoutSec 30 -ErrorAction Stop
                    if ($allReleases -and $allReleases.Count -gt 0) {
                        # Always use the latest (first) release
                        $version = $allReleases[0].tag_name
                        Write-Host "[INFO] Found $($allReleases.Count) release(s), using latest: $version"
                        break
                    } else {
                        Write-Host "[WARN] No releases found in repository, using fallback v1.0.0"
                        $version = "v1.0.0"
                        break
                    }
                } catch {
                    if ($i -eq 3) {
                        Write-Host "[ERROR] Could not fetch release information after 3 attempts: $($_.Exception.Message)"
                        Write-Host "[INFO] API URL attempted: $githubApiUrl/releases"
                        Write-Host "[INFO] This might be due to:"
                        Write-Host "   • GitHub API rate limiting (try again later)"
                        Write-Host "   • Network connectivity issues"
                        Write-Host "   • Firewall or proxy restrictions"
                        Write-Host "   • Geographic access restrictions"
                        Write-Host "[WARN] Using fallback version v1.0.0"
                        $version = "v1.0.0"
                        break
                    }
                    Write-Host "[WARN] Attempt $i failed, retrying..."
                    Start-Sleep -Seconds 2
                }
            }
        } catch {
            Write-Host "[ERROR] Could not fetch release information: $($_.Exception.Message)"
            Write-Host "[INFO] API URL attempted: $githubApiUrl/releases"
            Write-Host "[WARN] Using fallback version v1.0.0"
            $version = "v1.0.0"
        }
    }
}

# Construct download URL
# Remove 'v' prefix from version for binary name, but keep original version for download tag
$versionForBinary = $version.TrimStart('v')
$binaryName = "agb-$versionForBinary-windows-$Architecture.exe"
$downloadUrl = "https://github.com/$repoOwner/$repoName/releases/download/$version/$binaryName"

# Display installation info
Write-Host "Installation Details:"
Write-Host "   Repository: https://github.com/$repoOwner/$repoName"
Write-Host "   Version: $version"
Write-Host "   Architecture: $Architecture"
Write-Host "   Binary: $binaryName"
Write-Host "   Installation directory: $destination"
Write-Host "   Download URL: $downloadUrl"
Write-Host ""

# Create destination directory if it doesn't exist
try {
    if (!(Test-Path -Path $destination)) {
        Write-Host "[INFO] Creating installation directory at $destination"
        New-Item -ItemType Directory -Force -Path $destination -ErrorAction Stop | Out-Null
    }
} catch {
    Write-Error "[ERROR] Failed to create installation directory: $_"
    exit 1
}

# File to download
$outputFile = "$destination\agb.exe"

# Check if already installed and get current version
$upgrading = $false
if (Test-Path $outputFile) {
    try {
        $currentVersionOutput = & $outputFile version 2>$null
        if ($currentVersionOutput -match "version\s+([v\d\.]+)") {
            $currentVersion = $matches[1]
            if ($currentVersion -eq $version.TrimStart('v')) {
                Write-Host "[SUCCESS] AgbCloud CLI $version is already installed!"
                Write-Host "   Location: $outputFile"
                Write-Host ""
                Write-Host "[INFO] You're all set! Use 'agb --help' to get started."
                exit 0
            } else {
                Write-Host "[INFO] Upgrading from $currentVersion to $version"
                $upgrading = $true
            }
        } else {
            Write-Host "[INFO] Existing installation found, upgrading..."
            $upgrading = $true
        }
    } catch {
        Write-Host "[INFO] Existing installation found, upgrading..."
        $upgrading = $true
    }
    Write-Host ""
}

# Download the file with progress
try {
    if ($upgrading) {
        Write-Host "[INFO] Downloading AgbCloud CLI update..."
    } else {
        Write-Host "[INFO] Downloading AgbCloud CLI..."
    }
    Write-Host "   From: $downloadUrl"
    Write-Host "   To: $outputFile"

    # Use Invoke-WebRequest with progress
    $ProgressPreference = 'Continue'
    Invoke-WebRequest -Uri $downloadUrl -OutFile $outputFile -UseBasicParsing -ErrorAction Stop

    Write-Host ""
    Write-Host "[SUCCESS] Download complete!"
} catch {
    Write-Error "[ERROR] Failed to download AgbCloud CLI: $_"
    Write-Host ""
    Write-Host "Troubleshooting:"
    Write-Host "   1. Check your internet connection"
    Write-Host "   2. Verify the version exists: https://github.com/$repoOwner/$repoName/releases"
    Write-Host "   3. Try a different version: -Version v1.0.0"
    Write-Host "   4. Check if the architecture is correct: -Architecture amd64"
    exit 1
}

# Set executable permissions (Windows doesn't need this, but good practice)
try {
    Write-Host "[INFO] Setting up binary permissions..."
    Set-ItemProperty -Path $outputFile -Name IsReadOnly -Value $false -ErrorAction SilentlyContinue
} catch {
    Write-Host "   [WARN] Could not set binary permissions (this is usually fine on Windows)"
}

# Add to PATH if not already present
try {
    Write-Host "[INFO] Updating PATH environment variable..."
    
    $currentPath = [System.Environment]::GetEnvironmentVariable("Path", [System.EnvironmentVariableTarget]::User)
    if (-not $currentPath) { $currentPath = "" }
    
    $pathEntries = $currentPath -split ';' | ForEach-Object { $_.TrimEnd('\') }
    
    if (-not ($pathEntries | Where-Object { $_ -eq $destination })) {
        Write-Host "   Adding $destination to user PATH..."
        $newPath = if ($currentPath.EndsWith(';')) { "$currentPath$destination" } else { "$currentPath;$destination" }
        [System.Environment]::SetEnvironmentVariable("Path", $newPath, [System.EnvironmentVariableTarget]::User)
        Write-Host "[SUCCESS] PATH updated successfully!"
        Write-Host "   [TIP] Please restart your terminal or run a new PowerShell session"
    } else {
        Write-Host "[SUCCESS] Already in PATH"
    }
} catch {
    Write-Host "   [WARN] Could not automatically update PATH"
    Write-Host "   [MANUAL] Please manually add the following to your PATH:"
    Write-Host "      $destination"
    Write-Host ""
    Write-Host "   [STEPS] To add manually:"
    Write-Host "      1. Press Win+R, type 'sysdm.cpl', press Enter"
    Write-Host "      2. Click 'Environment Variables'"
    Write-Host "      3. Under 'User variables', select 'Path' and click 'Edit'"
    Write-Host "      4. Click 'New' and add: $destination"
    Write-Host "      5. Click OK to save"
}

Write-Host ""

# Test installation
Write-Host "[INFO] Testing installation..."
try {
    $installedVersion = & $outputFile version 2>$null
    if ($installedVersion) {
        Write-Host "[SUCCESS] Installation test successful!"
        Write-Host ""
        
        if ($upgrading) {
            Write-Host "[SUCCESS] AgbCloud CLI successfully upgraded to $version!"
        } else {
            Write-Host "[SUCCESS] AgbCloud CLI $version installed successfully!"
        }
        
        Write-Host "   Location: $outputFile"
        Write-Host "   Version: $installedVersion"
        Write-Host ""
        Write-Host "Quick Start:"
        Write-Host "   agb --help          # Show help"
        Write-Host "   agb version         # Show version"
        Write-Host "   agb login           # Login to AgbCloud"
        Write-Host ""
        Write-Host "Documentation:"
        Write-Host "   https://github.com/$repoOwner/$repoName"
        Write-Host ""
        Write-Host "[SUCCESS] Installation completed! 🎉"
    } else {
        Write-Host "[WARN] Installation completed but version check failed"
        Write-Host "   This might be normal if the binary requires additional setup"
        Write-Host "   Try running: $outputFile --help"
    }
} catch {
    Write-Host "[WARN] Installation completed but test failed: $_"
    Write-Host "   This might be normal if the binary requires additional setup"
    Write-Host "   Try running: $outputFile --help"
}

Write-Host ""
Write-Host "Thank you for using AgbCloud CLI! 🚀"